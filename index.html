let selectedFiles = [];
let batches = [];

// Handle file selection
function handleFileInput(event) {
    selectedFiles = Array.from(event.target.files);
    if (selectedFiles.length > 0) {
        resizeBtn.disabled = false;
    } else {
        resizeBtn.disabled = true;
    }
    displaySelectedImages();
}

// Split files into batches of 50
function splitIntoBatches(files) {
    batches = [];
    for (let i = 0; i < files.length; i += 50) {
        batches.push(files.slice(i, i + 50));
    }
}

// Display selected images before resizing
function displaySelectedImages() {
    output.innerHTML = '';
    selectedFiles.forEach((file) => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.alt = file.name;
        img.style.width = '100px'; // Display smaller preview size
        output.appendChild(img);
    });
}

// Resize images
function resizeImages() {
    splitIntoBatches(selectedFiles); // Split selected files into batches
    batches.forEach((batch, batchIndex) => {
        const resizedImages = [];
        let processedCount = 0;

        batch.forEach((file) => {
            const img = new Image();
            const reader = new FileReader();

            reader.onload = function(event) {
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const targetWidth = 250;
                    const targetHeight = 320;

                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                    canvas.toBlob(
                        (blob) => {
                            resizedImages.push({ name: file.name, blob: blob });
                            processedCount++;
                            if (processedCount === batch.length) {
                                createZip(resizedImages, batchIndex + 1); // Create ZIP for this batch
                            }
                        },
                        'image/jpeg',
                        0.8
                    );
                };
                img.src = event.target.result;
            };

            reader.readAsDataURL(file);
        });
    });
}

// Create a ZIP for a batch and provide a download link
function createZip(images, batchNumber) {
    const zip = new JSZip();
    const folder = zip.folder('resized_images_batch_' + batchNumber);

    images.forEach((image) => {
        folder.file(image.name, image.blob);
    });

    zip.generateAsync({ type: 'blob' }).then(function(content) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `resized_images_batch_${batchNumber}.zip`;
        link.textContent = `Download Batch ${batchNumber}`;
        link.style.display = 'block';
        link.style.marginTop = '10px';
        output.appendChild(link);
    });
}

// Event listeners
fileInput.addEventListener('change', handleFileInput);
resizeBtn.addEventListener('click', resizeImages);
